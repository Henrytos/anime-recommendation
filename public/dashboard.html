<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="./assets/styles/dashboard.css">
    <link rel="shortcut icon" href="./assets/icons/logo.png" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

    <dialog id="dialog_ia" class="close">
        <div class="content-dialog">
            <svg xmlns="http://www.w3.org/2000/svg" width="34" height="34" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
                class="lucide lucide-x-icon lucide-x " id="close-button" onclick="closeDialog()">
                <path d="M18 6 6 18" />
                <path d="m6 6 12 12" />
            </svg>

            <div>

                <span class="description">
                    <h3 id="h3_anime">Vinland Saga Season 2</h3>
                    <span class="tags">
                        <span class="tag" id="span_tag_gender">
                            Action
                        </span>
                        <span class="tag" id="span_tag_target_audience">
                            Shounen
                        </span>
                        <span class="tag" id="span_tag_score">
                            8.9
                        </span>
                    </span>
                    <p id="p_description">Henry_dev demonstra preferência por animes de ação, aventura e drama,
                        apreciando
                        tanto narrativas
                        emocionantes quanto
                        comédias e romances. A variedade de demografias indica um gosto diversificado, buscando
                        histórias
                        impactantes em
                        Shounen, Shoujo, Seinen e Josei.</p>
                </span>

                <a id="a_anime">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
                        class="lucide lucide-square-arrow-out-up-right-icon lucide-square-arrow-out-up-right">
                        <path d="M21 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h6" />
                        <path d="m21 3-9 9" />
                        <path d="M15 3h6v6" />
                    </svg>
                    <span>Ver Mais</span>
                </a>
            </div>

            <img src="https://i.pinimg.com/736x/73/d8/99/73d899caec8f9ebcb91b3d2f9be8f647.jpg" alt="" id="img_anime">
        </div>

    </dialog>

    <section class="start container">
        <nav class="nav-bar">
            <a href="./index.html">
                <img src="../assets/images/logo-home.png" id="logo" alt="logo" width="292" height="64">
            </a>
            <div class="buttons">
                <button class="button button-foreground icon" id="button_theme">
                    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
                        class="lucide lucide-sun-moon-icon lucide-sun-moon">
                        <path d="M12 8a2.83 2.83 0 0 0 4 4 4 4 0 1 1-4-4" />
                        <path d="M12 2v2" />
                        <path d="M12 20v2" />
                        <path d="m4.9 4.9 1.4 1.4" />
                        <path d="m17.7 17.7 1.4 1.4" />
                        <path d="M2 12h2" />
                        <path d="M20 12h2" />
                        <path d="m6.3 17.7-1.4 1.4" />
                        <path d="m19.1 4.9-1.4 1.4" />
                    </svg>
                </button>
                <button class="button button-foreground icon" id="button_git_hub_to_project">
                    <svg xmlns="http://www.w3.org/2000/svg" width="34" height="34" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
                        class="lucide lucide-github-icon lucide-github">
                        <path
                            d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4" />
                        <path d="M9 18c-4.51 2-5-2-7-2" />
                    </svg>
                </button>

                <button class="button button-foreground button-ia" id="button_ia" onclick="recommendationIa()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="34" height="34" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
                        class="lucide lucide-brain-circuit-icon lucide-brain-circuit">
                        <path
                            d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z" />
                        <path d="M9 13a4.5 4.5 0 0 0 3-4" />
                        <path d="M6.003 5.125A3 3 0 0 0 6.401 6.5" />
                        <path d="M3.477 10.896a4 4 0 0 1 .585-.396" />
                        <path d="M6 18a4 4 0 0 1-1.967-.516" />
                        <path d="M12 13h4" />
                        <path d="M12 18h6a2 2 0 0 1 2 2v1" />
                        <path d="M12 8h8" />
                        <path d="M16 8V5a2 2 0 0 1 2-2" />
                        <circle cx="16" cy="13" r=".5" />
                        <circle cx="18" cy="3" r=".5" />
                        <circle cx="20" cy="21" r=".5" />
                        <circle cx="20" cy="8" r=".5" />
                    </svg>

                    <span>
                        Recomendação IA
                    </span>
                </button>

                <a class="button button-foreground no-auth" href="./sign-up.html">Cadastrar</a>
                <a class="button button-foreground no-auth" href="./sign-in.html">Entrar</a>
                <a id="preview-profile" class="auth" href="./dashboard.html">

                </a>
                <button class="menu" type="button" id="button_open_menu">
                    <span class="line"></span>
                    <span class="line"></span>
                    <span class="line"></span>
                </button>
            </div>
        </nav>

        <div class="content">

            <div class="indicators">
                <div class="indicator">
                    <h4>Rank Atual</h4>

                    <p class="number" id="span_number_rank">
                        º RANK
                        <span class="percentage">
                            +2º
                        </span>
                    </p>

                    <span class="legend">
                        <p>Rank da semana passada: <span id="span_rank_last_week"></span></p>

                        <p id="p_legend_rank">Está acima da média da semana passada :)</p>
                    </span>
                    <img src="./assets/icons/icon-chat.svg" class="image-indicator" alt="">
                </div>

                <div class="indicator">
                    <h4>Nivel de engajamento</h4>

                    <p class="number" id="span_percentage_engagement">

                    </p>

                    <span class="legend">
                        <p>Quantidade de comentarios: <span id="span_quantity_comments"></span></p>

                        <p>Quantidade de recomendações : <span id="span_quantity_recommendations"></span></p>
                    </span>

                    <img src="./assets/icons/icon-star.svg" class="image-indicator" alt="">
                </div>

                <div class="indicator indicator-anime" onclick="redirectAnimePopular()">
                    <h4>Anime Mais Popular</h4>
                    <p class="number" id="title_anime">
                    </p>

                    <span class="legend">
                        <p>Top 1 Do Rank Da Plataforma</p>
                        <p>Foi Recomendado há + <span id="span_number_recommendation"></span> Usuarios</p>
                    </span>
                    <img src="./assets/icons/icon-chart.svg" class="image-indicator" alt="">

                    <img src="https://cdn.myanimelist.net/images/characters/7/525105.jpg?s=1706604ec2ca141a172526b8dedf3177"
                        alt="image-character" class="image-character" id="image_character">
                </div>
            </div>


            <div class="charts">
                <div class="chart-quizzes">
                    <h2 class="title">
                        Quizzes
                    </h2>

                    <div class="div-content-chart">
                        <canvas id="chart_bar_quizzes"></canvas>
                    </div>
                </div>


                <div class="chart-comments">
                    <h2 class="title">
                        Comentarios
                    </h2>

                    <div class="div-content-chart">
                        <canvas id="chart_bar_comments"></canvas>
                    </div>
                </div>

                <div class="chart-mapping">
                    <h2 class="title">
                        Mapeamento
                    </h2>

                    <div class="div-content-chart">
                        <canvas id="chart_pie_mapping"></canvas>
                    </div>
                </div>
            </div>

            <div class="histories">
                <div class="history-recommendation">
                    <div class="top">
                        <h2 class="title">
                            Histórico de Recomendações
                        </h2>

                        <div class="filters">
                            <select id="select_gender" onchange="searchRecommendation()"></select>
                            <select id="select_target_audience" onchange="searchRecommendation()"></select>
                        </div>
                    </div>

                    <div class="recommendations" id="div_recommendations"></div>

                    <div id="div_links">
                        <!-- PAGINATION -->
                        <div class="pagination" id="div_pagination"></div>
                    </div>
                </div>

                <div class="history-comments">
                    <h2 class="title">Histórico de comentários</h2>

                    <div id="div_comments" class="comments"></div>
                </div>
            </div>


        </div>

        <div class="layout">

            <span class="boxes top-left">
                <span class="box box-red-dark"></span>
                <span class="box box-red-light"></span>
                <span class="box box-red-light"></span>
            </span>
            <span class="boxes top-right">
                <span class="box box-purple-dark"></span>
                <span class="box box-purple-light"></span>
                <span class="box box-purple-light"></span>
            </span>
            <span class="boxes bottom-left">
                <span class="box box-purple-dark"></span>
                <span class="box box-purple-light"></span>
                <span class="box box-purple-light"></span>
            </span>
            <span class="boxes bottom-right">
                <span class="box box-red-dark"></span>
                <span class="box box-red-light"></span>
                <span class="box box-red-light"></span>
            </span>
        </div>

    </section>


    <!-- expand -->

    <div class="sheet" id="sheet">
        <span id="button_close_menu">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
                class="lucide lucide-x-icon lucide-x">
                <path d="M18 6 6 18" />
                <path d="m6 6 12 12" />
            </svg>
        </span>
        <div class="links">

            <span class="link">
                <a href="./index.html">Home</a>
            </span>
            <span class="link">
                <a href="./quizzes.html">Quizzes</a>
            </span>
            <span class="link auth">
                <a href="./dashboard.html" class="active">Dashboard</a>
            </span>
            <span class="link auth exit" id="button-exit">
                <span href="./index.html">
                    <p>Sair</p>

                    <svg xmlns="http://www.w3.org/2000/svg" width="56" height="56" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
                        class="lucide lucide-log-out-icon lucide-log-out">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                        <polyline points="16 17 21 12 16 7" />
                        <line x1="21" x2="9" y1="12" y2="12" />
                    </svg>
                </span>
            </span>
        </div>



    </div>


    <script>
        let page = 1, perPage = 10, maxPages = 1
        let animePopular = 0
        let mappingsList

        window.addEventListener("DOMContentLoaded", () => {
            const userId = sessionStorage.getItem("user_id")
            const headers = new Headers()
            headers.append("userId", userId)

            fetch("/users/metrics/kpi", {
                headers,
            }).then(responseMetricsKpi => responseMetricsKpi.json()).then(({ anime, engagement, rank }) => {
                renderKpis(anime, engagement, rank)
            })

            fetch("/users/metrics/chart", {
                headers,
            }).then((response) => response.json()).then(({ quizzes, mappings, comments: commentsUser }) => {
                renderCharts(quizzes, commentsUser, mappings)

                fetch("/users/recommendations", {
                    headers,
                }).then(response => response.json()).then(({
                    filtersGender,
                    filtersTargetAudience,
                    recommendations,
                    page: pageCurrentInitial,
                    maxPages: maxPagesInitial
                }) => {
                    page = pageCurrentInitial
                    maxPages = maxPagesInitial

                    renderRecommendations(recommendations)
                    renderFilterSelects(filtersGender, filtersTargetAudience)
                    renderPaginationButtons(page, maxPages)
                })
            })

            fetch("/users/comments", {
                headers,
            }).then((response) => response.json()).then(({ comments }) => {
                renderComments(comments)
            })
        })

        function recommendationIa() {
            const dialog = document.getElementById("dialog_ia")

            button_ia.innerHTML = 'Carregando...'


            const headers = new Headers()
            const userId = sessionStorage.user_id
            headers.append('userId', userId)

            fetch(`/users/recommendations/ia`, { headers }).then(response => response.json()).then(({ answer, anime }) => {
                h3_anime.innerHTML = answer.recommendation
                p_description.innerHTML = answer.description


                span_tag_gender.innerHTML = anime.gender
                span_tag_target_audience.innerHTML = anime.target_audience
                span_tag_score.innerHTML = anime.score
                a_anime.href = `./anime.html?animeId=${anime.anime_id}`
                img_anime.src = anime.image_url

                dialog.classList.remove("close")
                dialog.classList.add("open")

                searchRecommendation()
            }).finally(() => {
                button_ia.innerHTML = `
                 <svg xmlns="http://www.w3.org/2000/svg" width="34" height="34" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
                        class="lucide lucide-brain-circuit-icon lucide-brain-circuit">
                        <path
                            d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z" />
                        <path d="M9 13a4.5 4.5 0 0 0 3-4" />
                        <path d="M6.003 5.125A3 3 0 0 0 6.401 6.5" />
                        <path d="M3.477 10.896a4 4 0 0 1 .585-.396" />
                        <path d="M6 18a4 4 0 0 1-1.967-.516" />
                        <path d="M12 13h4" />
                        <path d="M12 18h6a2 2 0 0 1 2 2v1" />
                        <path d="M12 8h8" />
                        <path d="M16 8V5a2 2 0 0 1 2-2" />
                        <circle cx="16" cy="13" r=".5" />
                        <circle cx="18" cy="3" r=".5" />
                        <circle cx="20" cy="21" r=".5" />
                        <circle cx="20" cy="8" r=".5" />
                    </svg>

                    <span>
                        Recomendação IA
                    </span>
                `
            })
        }

        function closeDialog() {
            const dialog = document.getElementById("dialog_ia")

            dialog.classList.remove("open")
            dialog.classList.add("close")
        }

        function redirectAnimePopular() {
            window.location.href = `./anime.html?animeId=${animePopular}`
        }

        function searchRecommendation() {
            const gender = select_gender.value
            const targetAudience = select_target_audience.value

            const userId = sessionStorage.getItem("user_id")
            const headers = new Headers()
            headers.append("userId", userId)

            fetch(`/users/recommendations?gender=${gender}&targetAudience=${targetAudience}&page=${page}`, {
                headers,
            }).then(response => response.json()).then(({
                filtersGender,
                filtersTargetAudience,
                recommendations,
                page: pageCurrentInitial,
                maxPages: maxPagesInitial
            }) => {
                page = pageCurrentInitial
                maxPages = maxPagesInitial

                renderRecommendations(recommendations)
                renderPaginationButtons(page, maxPages)
            })
        }

        function changePage(nextPage) {
            const gender = select_gender.value
            const targetAudience = select_target_audience.value

            const userId = sessionStorage.getItem("user_id")
            const headers = new Headers()
            headers.append("userId", userId)

            fetch(`/users/recommendations?gender=${gender}&targetAudience=${targetAudience}&page=${nextPage}`, {
                headers,
            }).then(response => response.json()).then(({
                filtersGender,
                filtersTargetAudience,
                recommendations,
                page: pageCurrentInitial,
                maxPages: maxPagesInitial
            }) => {
                page = pageCurrentInitial
                maxPages = maxPagesInitial

                renderRecommendations(recommendations)
                renderPaginationButtons(nextPage, maxPages)
            })
        }

        function renderPaginationButtons(currentPage, maxPages) {
            let contentButtonPages = ''

            for (let page = 1; page <= maxPages; page++) {

                let className = 'button-page'

                if (page == currentPage) {
                    className = 'button-page-current'
                }

                contentButtonPages += `
                <button class='${className}' onclick='changePage(${page})'>
                    ${page}
                </button>
                `
            }

            div_pagination.innerHTML = contentButtonPages
        }

        function renderComments(commentsFromUser) {
            let contentComments = ''

            for (let count = 0; count < commentsFromUser.length; count++) {
                let comment = commentsFromUser[count]
                const avatarUrl = JSON.parse(sessionStorage.avatar_url)
                contentComments += `
                    <a class="comment" href='./anime.html?animeId=${comment.anime_id}'>
                        <img src="./assets/uploads/${avatarUrl}" alt="">
                        <div class="content">
                            <div class="content-text">
                            <h3 class="title-comment">${comment.username}</h3>
                            <p class="time">${comment.time_relative}</p>
                        </div>
                        <p class="details">
                        ${comment.description}
                        </p>
                        </div>
                    </a>
                    `
            }

            div_comments.innerHTML = contentComments
        }

        function renderFilterSelects(filtersGender, filtersTargetAudience) {
            let contentFilterGender = `
                    <option value='all'>
                        Todos  
                    </option>
            `
            for (let position = 0; position < filtersGender.length; position++) {
                const gender = filtersGender[position]
                contentFilterGender += `
                    <option value='${gender}'>
                        ${gender}    
                    </option>
                `
            }

            select_gender.innerHTML = contentFilterGender


            let contentFilterTargetAudience = `
                    <option value='all'>
                        Todos  
                    </option>
            `
            for (let position = 0; position < filtersTargetAudience.length; position++) {
                const targetAudience = filtersTargetAudience[position]
                contentFilterTargetAudience += `
                    <option value='${targetAudience}'>
                        ${targetAudience}    
                    </option>
                `
            }

            select_target_audience.innerHTML = contentFilterTargetAudience

        }

        function renderRecommendations(recommendations) {
            let contentRecommendations = ''

            console.log(recommendations)
            if (recommendations == undefined) {
                div_recommendations.innerHTML = `
                    <div class='not-found'>
                        <img src='./assets/images/not-found-loli.png' alt='nenhum comentario encontrado' width="427"  />
                        <h1 class="title-not-found">Ops parece que não temos essa combinação :( </h1>
                    </div>
                `
                return
            }

            for (let count = 0; count < recommendations.length; count++) {
                let recommendation = recommendations[count]

                const colorMap = {
                    [mappingsList[0]]: '#cb4648',
                    [mappingsList[1]]: '#a39fbf',
                    [mappingsList[2]]: '#313646',
                    [mappingsList[3]]: '#754946',
                    [mappingsList[4]]: '#f3f3f3',
                    [mappingsList[5]]: '#141617',
                    [mappingsList[6]]: '#6A92E8'
                };

                const backgroundColor = colorMap[recommendation.gender];
                const colorForeground = backgroundColor == '#f3f3f3' || backgroundColor == '#a39fbf' || backgroundColor == '#6A92E8' ? '#141617' : '#f3f3f3'

                contentRecommendations += `
                    <a  href="./anime.html?animeId=${recommendation.anime_id}" class="recommendation mapping-1" style="background-color:${backgroundColor}; ">
                            <img src="${recommendation.image_url}"
                                alt="image preview anime" class="recommendation-image-preview">
                            <h4 class="recommendation-title" style="color:${colorForeground}">
                                ${recommendation.title.length > 13 ? recommendation.title.slice(0, 13).concat("...") : recommendation.title}
                            </h4>
                    </a>
                    `
            }

            div_recommendations.innerHTML = contentRecommendations
        }

        function sortUserByPoints(users) {
            if (users.length <= 1) return users;

            let minorUserPoints = [];
            let majorUserPoints = [];

            let positionMedium = Math.floor(users.length / 2);
            let comparisonUser = users[positionMedium];

            for (let position = 0; position < users.length; position++) {
                let user = users[position];

                if (position == positionMedium) continue;

                if (user.total_points_last_week <= comparisonUser.total_points_last_week) minorUserPoints.push(user);
                else majorUserPoints.push(user);
            }

            return [...sortUserByPoints(majorUserPoints), comparisonUser, ...sortUserByPoints(minorUserPoints)];
        }

        function renderCharts(quizzes, comments, mappings) {

            const quizzesDates = []
            const quizzesQuantities = []

            for (let count = 0; count < quizzes.length; count++) {
                let quiz = quizzes[count]

                quizzesDates.push(quiz.date)
                quizzesQuantities.push(quiz.quantity)
            }

            const commentsDates = []
            const commentsQuantities = []

            for (let count = 0; count < comments.length; count++) {
                let quiz = comments[count]

                commentsDates.push(quiz.date)
                commentsQuantities.push(quiz.quantity)
            }

            const mappingsTargetList = []
            const mappingsQuantities = []

            for (let count = 0; count < mappings.length; count++) {
                let mapping = mappings[count]

                mappingsTargetList.push(mapping.gender)
                mappingsQuantities.push(mapping.number)
            }

            mappingsList = mappingsTargetList

            const optionsChartBarQuizzes = {
                type: 'bar',
                data: {
                    labels: quizzesDates,
                    datasets: [
                        {
                            label: 'Quantidade',
                            data: quizzesQuantities,
                            borderColor: '#cb4648',
                            backgroundColor: '#cb4648'
                        },
                    ]
                },
                options: {
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#fff'
                            }
                        },
                        datalabels: {
                            color: '#fff'

                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#fff',
                                beginAtZero: true,

                            }
                        },
                        y: {
                            ticks: {
                                color: '#fff',
                                beginAtZero: true,

                            }
                        },

                    }
                }
            }

            const optionsChartBarComments = {
                type: 'bar',
                data: {
                    labels: commentsDates,
                    datasets: [
                        {
                            label: 'Quantidade',
                            data: commentsQuantities,
                            borderColor: '#cb4648',
                            backgroundColor: '#cb4648'
                        },
                    ]
                },
                options: {
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#fff'
                            }
                        },
                        datalabels: {
                            color: '#fff'

                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#fff',
                                beginAtZero: true,

                            }
                        },
                        y: {
                            ticks: {
                                color: '#fff',
                                beginAtZero: true,

                            }
                        },

                    }
                }
            }

            const optionsChartPieMapping = {
                type: 'pie',
                data: {
                    labels: mappingsList,
                    datasets: [
                        {
                            label: 'Quantidade',
                            data: mappingsQuantities,
                            borderColor: ['#cb4648', '#a39fbf', '#313646', '#754946', '#f3f3f3', '#141617', '#6A92E8'],
                            backgroundColor: ['#cb4648', '#a39fbf', '#313646', '#754946', '#f3f3f3', '#141617', '#6A92E8']
                        },
                    ]
                },
                options: {
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#fff'
                            },
                            position: 'right'
                        }
                    },
                }
            }

            const chartBarQuizzes = new Chart(chart_bar_quizzes, optionsChartBarQuizzes)
            const chartBarComments = new Chart(chart_bar_comments, optionsChartBarComments)
            const chartPieMapping = new Chart(chart_pie_mapping, optionsChartPieMapping)
            const buttonTheme = document.getElementById('button_theme')

            buttonTheme.addEventListener("click", () => {
                const isDarkMode = document.body.className == 'dark'

                const color = isDarkMode ? '#000' : '#fff'

                chartBarQuizzes.options.scales.x.ticks.color = color
                chartBarQuizzes.options.scales.y.ticks.color = color

                chartPieMapping.options.plugins.legend.labels.color = color
                chartPieMapping.options.plugins.legend.labels.color = color

                chartBarQuizzes.update()
                chartPieMapping.update()
            })
        }

        function renderKpis(anime, engagement, rank) {
            animePopular = anime.anime_id
            const userId = JSON.parse(sessionStorage.user_id)

            image_character.src = anime.image_url
            title_anime.innerHTML = anime.title.length > 14 ? anime.title.slice(0, 14).concat("...") : anime.title
            span_number_recommendation.innerHTML = anime.quantity_recommendation

            span_quantity_comments.innerHTML = engagement.quantity_comments
            span_quantity_recommendations.innerHTML = engagement.quantity_recommendations

            const difference = engagement.percentage_current - 100
            span_percentage_engagement.innerHTML = `
                ${Number(engagement.percentage_current).toFixed(0)}%
                <span class="percentage" style='color:${difference > 0 ? '#84cc77' : '#cb4648'}'>
                    ${difference > 0 ? '+' : ''} ${difference.toFixed(1)}%
                </span>
            `

            let userRank = 1
            for (let position = 0; position < rank.length; position++) {
                const currentRank = rank[position]
                if (currentRank.user_id == userId) {
                    userRank = position + 1
                    break
                }
            }

            const rankLastWeek = sortUserByPoints(rank)
            let userRankLastWeek = 1

            for (let position = 0; position < rankLastWeek.length; position++) {
                const currentRank = rankLastWeek[position]
                if (currentRank.user_id == userId) {
                    userRank = position + 1
                    break
                }
            }

            const differenceRank = userRankLastWeek - userRank
            span_number_rank.innerHTML = `
                 ${userRank}º RANK
                 <span class="percentage"  style='color:${differenceRank >= 0 ? '#84cc77' : '#cb4648'}'>
                 ${differenceRank >= 0 ? '+' : '-'}${differenceRank.toFixed(1)}º
                 </span>
            `
            span_rank_last_week.innerHTML = userRankLastWeek

            if (userRank == 1) {
                p_legend_rank.innerHTML = `Parabéns ${JSON.parse(sessionStorage.username)} você é o top 1  🌟`
            } else if (userRank == userRankLastWeek) {
                p_legend_rank.innerHTML = `Foco no progresso ${JSON.parse(sessionStorage.username)} ✊`
            }
            else if (userRank > userRankLastWeek) {
                p_legend_rank.innerHTML = `Sempre evoluindo Parabéns ${JSON.parse(sessionStorage.username)} 🚀`
            } else {
                p_legend_rank.innerHTML = `Mais sorte na proxima ${JSON.parse(sessionStorage.username)} ❤️‍🩹`
            }
        }

    </script>
    <script src="./assets/javascript/redirects.js" type="module" defer></script>
    <script src="./assets/javascript/manege-storage-session.js" type="module" defer></script>
    <script src="./assets/javascript/on-click-button-theme.js" type="module" defer></script>
    <script src="./assets/javascript/on-click-toggle-menu.js" type="module" defer></script>
    <script src="./assets/javascript/on-click-in-link-in-sheet.js" type="module" defer></script>
    <script src="./assets/javascript/remove-item-in-page.js" type="module" defer></script>
    <script src="./assets/javascript/set-preview-profile.js" type="module" defer></script>
    <script src="./assets/javascript/on-click-button-exit.js" type="module" defer></script>




</body>

</html>