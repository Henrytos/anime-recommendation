<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="./assets/styles/dashboard.css">
    <link rel="shortcut icon" href="./assets/icons/logo.png" type="image/x-icon">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <section class="start container">
        <nav class="nav-bar">
            <a href="./index.html">
                <img src="../assets/images/logo-home.png" id="logo" alt="logo" width="292" height="64">
            </a>
            <div class="buttons">
                <button class="button button-foreground icon" id="button_theme">
                    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
                        class="lucide lucide-sun-moon-icon lucide-sun-moon">
                        <path d="M12 8a2.83 2.83 0 0 0 4 4 4 4 0 1 1-4-4" />
                        <path d="M12 2v2" />
                        <path d="M12 20v2" />
                        <path d="m4.9 4.9 1.4 1.4" />
                        <path d="m17.7 17.7 1.4 1.4" />
                        <path d="M2 12h2" />
                        <path d="M20 12h2" />
                        <path d="m6.3 17.7-1.4 1.4" />
                        <path d="m19.1 4.9-1.4 1.4" />
                    </svg>
                </button>
                <button class="button button-foreground icon" id="button_git_hub_to_project">
                    <svg xmlns="http://www.w3.org/2000/svg" width="34" height="34" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
                        class="lucide lucide-github-icon lucide-github">
                        <path
                            d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4" />
                        <path d="M9 18c-4.51 2-5-2-7-2" />
                    </svg>
                </button>
                <a class="button button-foreground no-auth" href="./sign-up.html">Cadastrar</a>
                <a class="button button-foreground no-auth" href="./sign-in.html">Entrar</a>
                <a id="preview-profile" class="auth" href="./index.html">

                </a>
                <button class="menu" type="button" id="button_open_menu">
                    <span class="line"></span>
                    <span class="line"></span>
                    <span class="line"></span>
                </button>
            </div>
        </nav>

        <div class="content">
            <div class="charts">
                <div class="chart-quizzes">
                    <h2 class="title">
                        Quizzes
                    </h2>

                    <div class="div-content-chart">
                        <canvas id="chart_bar_quizzes"></canvas>
                    </div>
                </div>

                <div class="indicators">

                </div>

                <div class="chart-mapping">
                    <h2 class="title">
                        Mapeamento
                    </h2>

                    <div class="div-content-chart">
                        <canvas id="chart_pie_mapping"></canvas>
                    </div>
                </div>
            </div>

            <div class="histories">
                <div class="history-recommendation">
                    <h2 class="title">
                        Histórico de Recomendações
                    </h2>

                    <div class="recommendations" id="div_recommendations"></div>
                </div>

                <div class="history-comments">
                    <h2 class="title">Histórico de comentários</h2>

                    <div id="div_comments" class="comments"></div>


                </div>

            </div>
        </div>

        <div class="layout">
            <span class="boxes top-left">
                <span class="box box-red-dark"></span>
                <span class="box box-red-light"></span>
                <span class="box box-red-light"></span>
            </span>
            <span class="boxes top-right">
                <span class="box box-purple-dark"></span>
                <span class="box box-purple-light"></span>
                <span class="box box-purple-light"></span>
            </span>
            <span class="boxes bottom-left">
                <span class="box box-purple-dark"></span>
                <span class="box box-purple-light"></span>
                <span class="box box-purple-light"></span>
            </span>
            <span class="boxes bottom-right">
                <span class="box box-red-dark"></span>
                <span class="box box-red-light"></span>
                <span class="box box-red-light"></span>
            </span>
        </div>
    </section>

    <!-- expand -->

    <div class="sheet" id="sheet">
        <span id="button_close_menu">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
                class="lucide lucide-x-icon lucide-x">
                <path d="M18 6 6 18" />
                <path d="m6 6 12 12" />
            </svg>
        </span>
        <div class="links">

            <span class="link">
                <a href="./index.html" class="active">Home</a>
            </span>
            <span class="link">
                <a href="./quizzes.html">Quizzes</a>
            </span>
            <span class="link">
                <a href="./index.html">Populares</a>
            </span>
            <span class="link">
                <a href="./index.html">Indicações</a>
            </span>
            <span class="link">
                <a href="./index.html">Autores</a>
            </span>

            <span class="link auth">
                <a href="./index.html">Configuração</a>
            </span>
            <span class="link auth exit" id="button-exit">
                <span href="./index.html">
                    <p>Sair</p>

                    <svg xmlns="http://www.w3.org/2000/svg" width="56" height="56" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
                        class="lucide lucide-log-out-icon lucide-log-out">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                        <polyline points="16 17 21 12 16 7" />
                        <line x1="21" x2="9" y1="12" y2="12" />
                    </svg>
                </span>
            </span>
        </div>


    </div>

    <script>


        window.addEventListener("DOMContentLoaded", async () => {

            const userId = sessionStorage.getItem("user_id")
            console.log({ userId })

            const headers = new Headers()
            headers.append("userId", userId)
            console.log(headers)

            const responseMetrics = await fetch("/users/metrics", {
                headers,
            })

            const dataMetrics = await responseMetrics.json()
            console.log(dataMetrics)
            const quizzes = dataMetrics.quizzes

            const quizzesDates = []
            const quizzesQuantities = []

            for (let count = 0; count < quizzes.length; count++) {
                let quiz = quizzes[count]

                quizzesDates.push(quiz.date)
                quizzesQuantities.push(quiz.quantity)
            }

            const mappings = dataMetrics.mappings
            const mappingsTarget = []
            const mappingsQuantities = []

            for (let count = 0; count < mappings.length; count++) {
                let mapping = mappings[count]

                mappingsTarget.push(mapping.gender)
                mappingsQuantities.push(mapping.number)
            }

            const optionsChartBarQuizzes = {
                type: 'bar',
                data: {
                    labels: quizzesDates,
                    datasets: [
                        {
                            label: 'Quantidade',
                            data: quizzesQuantities,
                            borderColor: '#cb4648',
                            backgroundColor: '#cb4648'
                        },
                    ]
                },
                options: {
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#fff'
                            }
                        },
                        datalabels: {
                            color: '#fff'

                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#fff',
                                beginAtZero: true,

                            }
                        },
                        y: {
                            ticks: {
                                color: '#fff',
                                beginAtZero: true,

                            }
                        },

                    }
                }
            }


            const optionsChartPieMapping = {
                type: 'pie',
                data: {
                    labels: mappingsTarget,
                    datasets: [
                        {
                            label: 'Quantidade',
                            data: mappingsQuantities,
                            borderColor: ['#cb4648', '#a39fbf', '#313646', '#754946'],
                            backgroundColor: ['#cb4648', '#a39fbf', '#313646', '#754946']
                        },
                    ]
                },
                options: {
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#fff'
                            },
                            position: 'right'
                        }
                    },
                }
            }

            const chartBarQuizzes = new Chart(chart_bar_quizzes, optionsChartBarQuizzes)
            const chartPieMapping = new Chart(chart_pie_mapping, optionsChartPieMapping)
            const buttonTheme = document.getElementById('button_theme')

            buttonTheme.addEventListener("click", () => {
                const isDarkMode = document.body.className == 'dark'

                const color = isDarkMode ? '#000' : '#fff'
                console.log({
                    chartBarQuizzes, chartPieMapping
                })
                console.log({
                    color,
                    isDarkMode
                })
                chartBarQuizzes.options.scales.x.ticks.color = color
                chartBarQuizzes.options.scales.y.ticks.color = color

                chartPieMapping.options.plugins.legend.labels.color = color
                chartPieMapping.options.plugins.legend.labels.color = color

                chartBarQuizzes.update()
                chartPieMapping.update()
            })


            const responseRecommendations = await fetch("/users/recommendations", {
                headers,
            })
            const dataRecommendations = await responseRecommendations.json()
            const recommendations = dataRecommendations.recommendations
            console.log({
                recommendations
            })
            let contentRecommendations = ''

            for (let count = 0; count < recommendations.length; count++) {
                let recommendation = recommendations[count]
                let color = ""

                if (recommendation.gender == mappingsTarget[0]) {
                    color = '#cb4648'
                }
                else if (recommendation.gender == mappingsTarget[1]) {
                    color = '#a39fbf'
                }
                else if (recommendation.gender == mappingsTarget[2]) {
                    color = '#313646'
                }
                else if (recommendation.gender == mappingsTarget[3]) {
                    color = '#754946'
                }

                contentRecommendations += `
                  <div class="recommendation mapping-1" style="background-color:${color}">
                        <a href="./anime.html?animeId=${recommendation.anime_id}" class="recommendation">
                            <img src="${recommendation.image_url}"
                                alt="image preview anime" class="recommendation-image-preview">
                            <h4 class="recommendation-title">
                                ${recommendation.title.length > 15 ? recommendation.title.slice(0, 15).concat("...") : recommendation.title}
                            </h4>
                        </a>
                    </div>
                `
            }
            div_recommendations.innerHTML = contentRecommendations



            const responseComments = await fetch("/users/comments", {
                headers,
            })
            const dataComments = await responseComments.json()
            const comments = dataComments.comments.slice(0, 5)
            let contentComments = ''

            for (let count = 0; count < comments.length; count++) {
                let comment = comments[count]

                contentComments += `
                    <a class="comment" href='./anime.html?animeId=${comment.anime_id}'>
                        <img src="./assets/uploads/henry-profile.png" alt="">
                        <div class="content">
                            <div class="content-text">
                            <h3 class="title-comment">${comment.username}</h3>
                            <p class="time">${comment.time_relative}</p>
                        </div>
                        <p class="details">
                        ${comment.description}
                        </p>
                        </div>
                    </a>
                `
            }

            div_comments.innerHTML = contentComments


        })

    </script>

    <script src="./assets/javascript/redirects.js" type="module" defer></script>
    <script src="./assets/javascript/manege-storage-session.js" type="module" defer></script>
    <script src="./assets/javascript/on-click-button-theme.js" type="module" defer></script>
    <script src="./assets/javascript/on-click-toggle-menu.js" type="module" defer></script>
    <script src="./assets/javascript/on-click-in-link-in-sheet.js" type="module" defer></script>
    <script src="./assets/javascript/remove-item-in-page.js" type="module" defer></script>
    <script src="./assets/javascript/set-preview-profile.js" type="module" defer></script>

    <script src="./assets/javascript/on-click-button-exit.js" type="module" defer></script>



</body>

</html>